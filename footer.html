<script>
// ==========================================
// 1. 全てのクリックイベントを一括管理（イベント委譲）
// ==========================================
document.addEventListener('click', function (e) {
    // A. メインヘッダー全体の開閉（トグルボタン）
    const headerToggle = e.target.closest('#header-toggle-btn');
    if (headerToggle) {
        const wrapper = document.getElementById('score-wrapper');
        if (wrapper) {
            const isCollapsed = wrapper.classList.toggle('is-collapsed');
            localStorage.setItem('headerCollapsed', isCollapsed);
            adjustBodyPadding();
        }
        return;
    }

    // B. ロースター（選手名鑑）の開閉
    const playerToggle = e.target.closest('.player-toggle');
    if (playerToggle) {
        const sub = playerToggle.querySelector('.player-sub');
        if (sub) {
            const isOpen = sub.style.maxHeight;
            sub.style.maxHeight = isOpen ? null : sub.scrollHeight + 'px';
            sub.style.opacity = isOpen ? '0' : '1';
        }
        return;
    }

    // C. 凡例ボックス/フィルターの開閉
    const legendHeader = e.target.closest('.legend-header');
    if (legendHeader) {
        e.preventDefault();
        const box = legendHeader.closest('.legend-box, .filter-toggle');
        const content = box ? box.querySelector('.legend-content') : null;
        if (box && content) {
            const isOpen = box.getAttribute('aria-expanded') === 'true';
            content.style.maxHeight = isOpen ? '0px' : content.scrollHeight + 'px';
            content.style.opacity = isOpen ? '0' : '1';
            box.setAttribute('aria-expanded', !isOpen);
        }
        return;
    }

    // D. 戦績バーの開閉（リアルタイム同期版）
    const recordBtn = e.target.closest('.jax-record-main');
    if (recordBtn) {
        const recordBar = document.getElementById('jax-record-bar');
        if (recordBar) {
            const isOpen = recordBar.classList.toggle('is-open');
            recordBtn.setAttribute('aria-expanded', isOpen);
            let start = null;
            function sync(t) {
                if (!start) start = t;
                adjustBodyPadding(); 
                if (t - start < 350) requestAnimationFrame(sync);
            }
            requestAnimationFrame(sync);
        }
        return;
    }

    // E. トップへ戻るボタン
    const topBtn = e.target.closest('#scroll-top-button');
    if (topBtn) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: "smooth" });
        return;
    }
});

// ==========================================
// 2. ページ読み込み時の初期化
// ==========================================
document.addEventListener('DOMContentLoaded', function () {
    const wrapper = document.getElementById('score-wrapper');
    
    // --- 記憶に基づいたヘッダー状態の復元 ---
    const headerState = localStorage.getItem('headerCollapsed');
    if (wrapper && headerState === 'true') {
        wrapper.classList.add('is-collapsed');
    }

    // --- 年齢・NFLキャリア年数計算 ---
    const today = new Date();
    document.querySelectorAll('.player-age').forEach(el => {
        const birth = new Date(el.dataset.birthday);
        let age = today.getFullYear() - birth.getFullYear();
        if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--;
        const m = (today.getMonth() - birth.getMonth() + 12) % 12;
        el.innerHTML = `${age}<span style="font-size: 80%;">.${m}</span>歳`;
    });
    document.querySelectorAll('.player-year').forEach(el => {
        const entryYear = parseInt(el.dataset.entry, 10);
        const exp = today.getFullYear() - entryYear;
        el.innerHTML = (exp === 0) ? '(R)' : `(${exp})`;
    });

    // --- 前のページボタン ---
    const pager = document.querySelector(".pager");
    if (pager && location.search.indexOf("?page=") === 0) {
        const a = document.createElement('a');
        a.onclick = () => history.back();
        a.innerHTML = "前のページ";
        a.setAttribute("href", "javascript:void(0);");
        const span = document.createElement('span');
        span.className = 'pager-prev';
        span.appendChild(a);
        pager.insertBefore(span, pager.firstChild);
    }

    // --- データ読み込み開始 ---
    fetchJAXHeaderData();
    adjustBodyPadding();
});

// ==========================================
// 3. システム関数（取得・制御）
// ==========================================

// ヘッダーデータの取得
function fetchJAXHeaderData() {
    // スコア・戦績
    fetch('/schedule-latest').then(res => res.text()).then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const source = doc.querySelector('.entry-content') || doc.querySelector('.page-entry-content');
        if (source) {
            const newScore = source.querySelector('#score-bar');
            const newRecord = source.querySelector('#jax-record-bar');
            if (newScore) document.getElementById('score-bar').innerHTML = newScore.innerHTML;
            if (newRecord) document.getElementById('jax-record-bar').innerHTML = newRecord.innerHTML;
            setTimeout(initCarouselLogic, 10);
        }
    });

    // ニュース（See More含む）
    fetch('/news-latest').then(res => res.text()).then(html => {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const items = doc.querySelectorAll('.news-item');
        const list = document.getElementById('dynamic-news-bar');
        if (items.length > 0 && list) {
            let h = "";
            items.forEach(item => {
                const date = item.querySelector(".news-item-date").textContent.split("/").slice(1).join("/");
                const typeClass = item.dataset.type;
                const typeText = item.querySelector(".news-item-type").textContent;
                const title = item.querySelector(".news-item-title");
                h += `<li class="newsbar-b-item"><span class="newsbar-b-date">${date}</span><span class="newsbar-b-type newsbar-b-type--${typeClass}">${typeText}</span><a href="${title.href}" class="newsbar-b-title">${title.textContent}</a></li>`;
            });
            h += `<li class="newsbar-b-item"><a href="/news" class="newsbar-b-more-link">See More</a></li>`;
            list.innerHTML = h + h;
            startNewsScroll();
        }
    });
}

// カルーセル制御
function initCarouselLogic() {
    const vn = document.querySelector(".schedule-carousel-viewport");
    const carousel = document.querySelector(".schedule-carousel");
    const slides = document.querySelectorAll(".schedule-slide");
    if (!carousel || slides.length === 0) return;

    let index = 0;
    let minDiff = Infinity;
    const now = new Date();
    slides.forEach((slide, i) => {
        const dateStr = slide.dataset.date;
        if (dateStr) {
            const date = new Date(dateStr);
            const diff = Math.abs(date - now);
            if (diff < minDiff) { minDiff = diff; index = i; }
        }
    });

    const update = () => {
        const sw = 200; 
        const offset = -index * sw + (vn.offsetWidth - sw) / 2;
        carousel.style.transition = "transform 0.3s ease-out";
        carousel.style.transform = `translateX(${offset}px)`;
    };

    const prev = document.querySelector(".schedule-prev");
    const next = document.querySelector(".schedule-next");
    if (prev) prev.onclick = () => { index = (index - 1 + slides.length) % slides.length; update(); };
    if (next) next.onclick = () => { index = (index + 1) % slides.length; update(); };

    let startX = 0;
    vn.addEventListener("touchstart", e => { startX = e.changedTouches[0].screenX; }, {passive: true});
    vn.addEventListener("touchend", e => {
        const endX = e.changedTouches[0].screenX;
        if (endX < startX - 30) { index = (index + 1) % slides.length; update(); }
        else if (endX > startX + 30) { index = (index - 1 + slides.length) % slides.length; update(); }
    }, {passive: true});

    update();
    window.addEventListener('resize', update);
}

// ニューススクロール
function startNewsScroll() {
    const vn = document.querySelector(".newsbar-b-viewport");
    const ln = document.querySelector(".js-newsbar-b-list");
    if (!vn || !ln) return;
    const originalWidth = ln.scrollWidth / 2;
    let x = vn.scrollLeft;
    let interacting = false;
    let timer = null;

    const animate = () => {
        if (!interacting) {
            x += 0.5;
            if (x >= originalWidth) x -= originalWidth;
            vn.scrollLeft = x;
        }
        requestAnimationFrame(animate);
    };

    const stop = () => { interacting = true; if (timer) clearTimeout(timer); };
    const start = () => { timer = setTimeout(() => { x = vn.scrollLeft; interacting = false; }, 1500); };

    vn.addEventListener("touchstart", stop, { passive: true });
    vn.addEventListener("touchmove", stop, { passive: true });
    vn.addEventListener("touchend", start, { passive: true });
    vn.addEventListener("mouseenter", stop);
    vn.addEventListener("mouseleave", start);
    animate();
}

// 高さを測ってページ全体の余白を調整する関数
function adjustBodyPadding() {
    const wrapper = document.getElementById('score-wrapper');
    if (!wrapper) return;

    // 透過の判定（at-topクラス）
    wrapper.classList.toggle('at-top', window.scrollY < 10);

    let heightValue = 0;

    // 1. 閉じている場合は 0
    if (wrapper.classList.contains('is-collapsed')) {
        heightValue = 0;
    } 
    // 2. 開いている場合
    else {
        const scoreBar = document.getElementById('score-bar');
        // fetch前は、CSSの予約席(155/140)を維持
        if (scoreBar && scoreBar.innerHTML.trim() === "") {
            const isMobile = window.innerWidth <= 768;
            heightValue = isMobile ? 140 : 155;
        } else {
            // データがあるなら実測値を採用
            heightValue = wrapper.offsetHeight;
        }
    }

    // CSS変数だけを更新
    document.documentElement.style.setProperty('--header-height', heightValue + 'px');
}

// イベント監視
window.addEventListener('resize', adjustBodyPadding);
window.addEventListener('scroll', adjustBodyPadding);

</script>
